<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content=noodp><meta name=author content=Bluepie><meta name=description content="Public Journal of aghontpi"><meta name=keywords content="aghontpi bluepie Journal"><link rel=prev href=//bluepie.in/2020/04/xkcd-declutter/><link rel=next href=//bluepie.in/2020/05/its-been-two-years/><link rel=canonical href=//bluepie.in/2020/05/github-workflow/><link rel=apple-touch-icon sizes=180x180 href=//bluepie.in/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=//bluepie.in/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=//bluepie.in/favicon-16x16.png><link rel=manifest href=//bluepie.in/site.webmanifest><link rel=mask-icon href=//bluepie.in/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#da532c><meta name=theme-color content=#ffffff><title>Github Workflow | Bluepie&#39;s Journal</title><meta name=title content="Github Workflow | Bluepie's Journal"><link rel=stylesheet href=//bluepie.in/font/iconfont.css><link rel=stylesheet href=//bluepie.in/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"\/\/bluepie.in\/"},"articleSection":"posts","name":"Github Workflow","headline":"Github Workflow","description":"Hi\x26hellip; how ya been, its been a month already, gosh times flies by really fast. Status update: I\x26rsquo;ve been doing good, When I am in home I complete the work that I plan\x26hellip; far better than when I am in Chennai. The corona virus pandemic is still around the world at large, US right now is the largest affected country with over 70k dead people as of writing this. The lockdown in India has been extended another 2 weeks.","inLanguage":"en-us","author":"Bluepie","creator":"Bluepie","publisher":"Bluepie","accountablePerson":"Bluepie","copyrightHolder":"Bluepie","copyrightYear":"2020","datePublished":"2020-05-01 23:32:58 \x2b0530 \x2b0530","dateModified":"2020-05-01 23:32:58 \x2b0530 \x2b0530","url":"\/\/bluepie.in\/2020\/05\/github-workflow\/","wordCount":"744","keywords":["Bluepie\x27s Journal"]}</script><script type=text/javascript>(function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window,document,"clarity","script","9oioq6tja4");</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="extra extra-moon"></i></a>&nbsp;<a href=//bluepie.in/>Bluepie&#39;s Journal</a></div><div class="menu navbar-right"><a class=menu-item href=//bluepie.in/posts/>My Journal</a>
<a class=menu-item href=//bluepie.in/categories/>Categories</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="extra extra-moon"></i></a>&nbsp;<a href=//bluepie.in/>Bluepie&#39;s Journal</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=//bluepie.in/posts/>My Journal</a>
<a class=menu-item href=//bluepie.in/categories/>Categories</a></div></div></nav><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-135013873-2','auto');ga('send','pageview');}</script><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Github Workflow</h1><div class=post-meta>Written by <a itemprop=name href=//bluepie.in/ rel=author>Bluepie</a> with â™¥
<span class=post-time>on <time datetime=2020-05-01 itemprop=datePublished>May 1, 2020</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=//bluepie.in/categories/tech/>Tech</a>
<a href=//bluepie.in/categories/github-actions/>github-actions</a>
<a href=//bluepie.in/categories/development/>development</a>
<a href=//bluepie.in/categories/python/>Python</a></span></div></header><div class=post-content><img src=//bluepie.in/images/posts/githubWrokflow.png class=featured_image><p><strong><em>Hi&hellip; how ya been, its been a month already, gosh times flies by really fast. Status update: I&rsquo;ve been doing good, When I am in home I complete the work that I plan&hellip; far better than when I am in Chennai. The corona virus pandemic is still around the world at large, US right now is the largest affected country with over 70k dead people as of writing this. The lockdown in India has been extended
another 2 weeks.</em></strong></p><hr><h2 id=note-i-have-edited-this-post-because-of-the-changes-i-made-after-publishing-this-post>Note: I have edited this post, because of the changes I made, after publishing this post.</h2><blockquote><p>This post is going to be about github actions.</p></blockquote><h2 id=why>Why</h2><p>Automate a process after commit, schedule a process to be done timely&hellip;etc the possibililties are endless. A little background&hellip; lastweek
github announced unlimited private colaborations and made a ton of premium features completely free.</p><p><em>I am going to use this feature entirely for a different purpose, It further backs-up my saying..literally anything can be done.</em></p><h2 id=goal>Goal</h2><ul><li><p>I have this github repository which is XKCD viewer, which utilises api &lsquo;<a href="https://xkcd.com/info.0.json'" rel="nofollow noreferrer" target=_blank>https://xkcd.com/info.0.json'</a>. The api does not provide cors.</p></li><li><p>I want to clone the api, (the clone must be updated daily).</p></li><li><p>should provide cors support.</p></li><li><p>should not contain any external dependencies like server to set it up.</p></li></ul><h2 id=solution>Solution</h2><ul><li><p>github offers unlimited time constraint for github actions(public repository)</p></li><li><p>using github actions I could setup a bot that runs timely.</p></li><li><p>I can mainatain a local copy of the api, compare it to the offical every day,</p></li><li><p>if there is difference, then download the new contents and update the local state.</p></li><li><p>commit the changes directly to the repository.</p></li></ul><h2 id=approach>Approach</h2><ul><li><p>Im going with python in conjunction with workflow file, since I want to brush up my python skills.</p></li><li><p>The python logic will maintain a local state, add new contents, update itself i.e. the state.</p></li><li><p>I am going to use json to maintain the state.</p></li><li><p>The api data will be stored under a folder with every entry having a unique folder.</p></li><li><p>Use github actions to commit the changes to the directory.</p></li><li><p>Use github secrets to maintain a token, (token used to commit diretly to repository)</p></li></ul><h2 id=result>Result.</h2><p>After coding away the mentioned logics above. I am left with this workflow file.</p><pre><code class=language-yaml>name: fetch new content from api
on:
  schedule:
    - cron: '0 */8 * * *'

jobs:
  fetch-content:
    if: github.repository == 'aghontpi/xkcd-declutter'
    name: execute python logic
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v1
      - name: install requests pip3
        run: pip3 install requests
      - name: run python logic
        run: python3 ./.github/workflows/update_xkcd_official.py
      - name: status of the new folder
        run: git status xkcd-offline/ --porcelain
      - name: add new files
        run: |
          git config --local user.name &quot;xkcd-content-fetcher-bot&quot;
          git add xkcd-offline/
      - name: commit new content
        run: (awk '{print &quot;added content &quot; substr($3, match($3,&quot;\&quot;&quot;), match($3,&quot;}&quot;)-1) &quot;.&quot;}' xkcd-offline/state.json) | git commit -F -
      - name: push the new content
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.TOKEN }}
</code></pre><p>See it in action, downloads new content automatically and put it under the folder xkcd-offline.</p><p><a href=https://github.com/aghontpi/mirror-xkcd-api/ rel="nofollow noreferrer" target=_blank>Link to project github</a></p><h2 id=updates-post-edit>Updates/Post Edit</h2><p>After I published this post, Github made changes to how an environment variable is accessed, changes contains the following.</p><ul><li>updates to accessing environment variable.</li><li>decided to log while every run, that is persistent in the repository.</li><li>run every 12 hours instead of 8 hours.</li><li>added github actions bot as the author in commit message</li><li>update instructions to how to use this API (supporting cors)</li></ul><p><strong>updates to yaml</strong></p><pre><code class=language-yaml>name: Sync with Api
on:
  schedule:
    - cron: '0 */12 * * *'

jobs:
  fetch-content:
    if: github.repository == 'aghontpi/mirror-xkcd-api'
    name: execute python logic
    runs-on: ubuntu-latest
    env:
      new_content: true
    steps:
      - uses: actions/checkout@v1
      - name: install requests pip3
        run: pip3 install requests
      - name: run python logic
        run: python3 ./sync.py
      - name: status of the new folder
        run: git status api/ --porcelain
      - name: add new files
        run: |
          git config --local user.name &quot;sync bot&quot;
          git config --local user.email &quot;41898282+github-actions[bot]@users.noreply.github.com&quot;
          git add *
      - name: commit new content
        id: newfiles
        run: (awk '{print &quot;added content &quot; substr($3, match($3,&quot;\&quot;&quot;), match($3,&quot;}&quot;)-1) &quot;.&quot;}' syncState.json) | git commit -F -
        continue-on-error: true
      - name: not proceed if there is no new files
        if: steps.newfiles.outcome == 'failure' &amp;&amp; env.new_content == 'true'
        run: |
          echo &quot;no new content was fetched&quot;
          echo &quot;new_content=false&quot; &gt;&gt; $GITHUB_ENV
      - name: push the new content
        if: env.new_content == 'true'
        uses: ad-m/github-push-action@master
        with:
          github_token: ${{ secrets.TOKEN }}
          branch: main
</code></pre><p><strong>how to use this as an api(supporting cors)</strong></p><p><a href=https://github.com/aghontpi/mirror-xkcd-api/blob/main/README.md rel="nofollow noreferrer" target=_blank>Instructions/Usage</a></p><h2 id=end>End</h2><blockquote><p>See you soon, untill then hope you do well. - Gopinath aka aghontpi aka bluepie</p></blockquote></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Bluepie</span></p><p class=copyright-item><span>Link:</span>
<a href=//bluepie.in/2020/05/github-workflow/>//bluepie.in/2020/05/github-workflow/</span></p></div><div class=post-tags><section><a href=javascript:window.history.back();>back</a></span> Â·
<span><a href=//bluepie.in/>home</a></span></section></div><div class=post-nav><a href=//bluepie.in/2020/04/xkcd-declutter/ class=prev rel=prev title="Xkcd Declutter"><i class="iconfont icon-left"></i>&nbsp;Xkcd Declutter</a>
<a href=//bluepie.in/2020/05/its-been-two-years/ class=next rel=next title="Its Been Two Years..may">Its Been Two Years..may&nbsp;<i class="iconfont icon-right"></i></a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"gopinath001-github-io-blog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2017 - 2022</span>
<span class=with-love>|</span>
<span class=author itemprop=copyrightHolder><a href=//bluepie.in/>Bluepie</a></span></div></footer><script src=//bluepie.in/js/vendor_no_gallery.min.js async></script></div></body></html>