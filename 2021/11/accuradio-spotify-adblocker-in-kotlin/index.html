<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="chrome=1"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=robots content=noodp><meta name=author content=Bluepie><meta name=description content="Public Journal of aghontpi"><meta name=keywords content="aghontpi bluepie Journal"><link rel=prev href=//bluepie.in/2021/10/open-source-dnd-email-editor/><link rel=canonical href=//bluepie.in/2021/11/accuradio-spotify-adblocker-in-kotlin/><link rel=apple-touch-icon sizes=180x180 href=//bluepie.in/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=//bluepie.in/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=//bluepie.in/favicon-16x16.png><link rel=manifest href=//bluepie.in/site.webmanifest><link rel=mask-icon href=//bluepie.in/safari-pinned-tab.svg color=#5bbad5><meta name=msapplication-TileColor content=#da532c><meta name=theme-color content=#ffffff><title>Accuradio, Spotify...etc Adblocker in Kotlin | Bluepie&#39;s Journal</title><meta name=title content="Accuradio, Spotify...etc Adblocker in Kotlin | Bluepie's Journal"><link rel=stylesheet href=//bluepie.in/font/iconfont.css><link rel=stylesheet href=//bluepie.in/css/main.min.css><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"\/\/bluepie.in\/"},"articleSection":"posts","name":"Accuradio, Spotify...etc Adblocker in Kotlin","headline":"Accuradio, Spotify...etc Adblocker in Kotlin","description":"Hello how you been?, hope everything is going well.\nI wanted to learn Kotlin for native Android development, I already knew how to do it with java, so the only obstacle for me is learning Kotlin.\nKotlin  Kotlin trello board that I used to track progress. After learning the basics for Kotlin, Kotlin koans is a great place for practice (beginner to advanced).  Chosing what to do with Kotlin I use Accuradio android app to stream music, but it does not have a paid tear, So the ads are not skippable and there was no existing adblocker that does this(which is a pain).","inLanguage":"en-us","author":"Bluepie","creator":"Bluepie","publisher":"Bluepie","accountablePerson":"Bluepie","copyrightHolder":"Bluepie","copyrightYear":"2021","datePublished":"2021-11-18 19:46:00 \x2b0000 UTC","dateModified":"2021-11-18 19:46:00 \x2b0000 UTC","url":"\/\/bluepie.in\/2021\/11\/accuradio-spotify-adblocker-in-kotlin\/","wordCount":"574","keywords":["Bluepie\x27s Journal"]}</script><script type=text/javascript>(function(c,l,a,r,i,t,y){c[a]=c[a]||function(){(c[a].q=c[a].q||[]).push(arguments)};t=l.createElement(r);t.async=1;t.src="https://www.clarity.ms/tag/"+i;y=l.getElementsByTagName(r)[0];y.parentNode.insertBefore(t,y);})(window,document,"clarity","script","9oioq6tja4");</script></head><body><div class=wrapper><nav class=navbar><div class=container><div class="navbar-header header-logo"><a href=javascript:void(0); class=theme-switch><i class="extra extra-moon"></i></a>&nbsp;<a href=//bluepie.in/>Bluepie&#39;s Journal</a></div><div class="menu navbar-right"><a class=menu-item href=//bluepie.in/posts/>My Journal</a>
<a class=menu-item href=//bluepie.in/categories/>Categories</a></div></div></nav><nav class=navbar-mobile id=nav-mobile style=display:none><div class=container><div class=navbar-header><div><a href=javascript:void(0); class=theme-switch><i class="extra extra-moon"></i></a>&nbsp;<a href=//bluepie.in/>Bluepie&#39;s Journal</a></div><div class=menu-toggle><span></span><span></span><span></span></div></div><div class=menu id=mobile-menu><a class=menu-item href=//bluepie.in/posts/>My Journal</a>
<a class=menu-item href=//bluepie.in/categories/>Categories</a></div></div></nav><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-135013873-2','auto');ga('send','pageview');}</script><main class=main><div class=container><article class=post-warp itemscope itemtype=http://schema.org/Article><header class=post-header><h1 class=post-title itemprop="name headline">Accuradio, Spotify...etc Adblocker in Kotlin</h1><div class=post-meta>Written by <a itemprop=name href=//bluepie.in/ rel=author>Bluepie</a> with â™¥
<span class=post-time>on <time datetime=2021-11-18 itemprop=datePublished>November 18, 2021</time></span>
in
<i class="iconfont icon-folder"></i><span class=post-category><a href=//bluepie.in/categories/teach/>Teach</a>
<a href=//bluepie.in/categories/android/>Android</a>
<a href=//bluepie.in/categories/kotlin/>Kotlin</a></span></div></header><div class=post-content><img src=//bluepie.in/images/posts/accuradio-spotify-ad-blocker/ad-silence.png class=featured_image><p><strong><em>Hello how you been?, hope everything is going well.</em></strong></p><p>I wanted to learn Kotlin for native Android development, I already knew how to do it with java, so the only obstacle for me is learning Kotlin.</p><h2 id=kotlin>Kotlin</h2><ul><li>Kotlin <a href=https://trello.com/c/zYFtp51G/1-learn-kotlin rel="nofollow noreferrer" target=_blank>trello board</a> that I used to track progress.</li><li>After learning the basics for Kotlin, <a href=https://play.kotlinlang.org/koans/overview rel="nofollow noreferrer" target=_blank>Kotlin koans</a> is a great place for practice (beginner to advanced).</li></ul><h2 id=chosing-what-to-do-with-kotlin>Chosing what to do with Kotlin</h2><p>I use <a href=https://accuradio.com/ rel="nofollow noreferrer" target=_blank>Accuradio</a> android app to stream music, but it does not have a paid tear, So the ads are not skippable and there was no existing adblocker that does this(which is a pain). So I decided to write one in Kotlin.</p><p>So its decided, I am doing a project in Kotlin to block/silence ads in Accuradio, some additional things I decided to implement are the following.</p><ul><li>should be extensible to other apps like Spotify,&hellip;etc</li><li>should have minimal UI</li><li>should be lightweight</li><li>should be completely openSource.</li></ul><p>To be extensbile, I should have a common pattern/way to detect ads in these apps&hellip; One such way is by using app&rsquo;s notification.</p><p>I can determine what an app is currenly playing using the notification, using the <a href=https://developer.android.com/reference/android/app/NotificationListenerService rel="nofollow noreferrer" target=_blank>notification listener</a> service and parsing the posted notifications, mute/unmute the app based on the content.</p><p><figure><img src=//bluepie.in/images/ring.svg data-sizes=auto data-src=//bluepie.in/images/posts/accuradio-spotify-ad-blocker/flow.png alt class=lazyload><figcaption class=image-caption></figcaption></figure></p><blockquote><p>An update, <strong>I already added support for Spotify and Tidal.</strong></p></blockquote><h2 id=implementation>Implementation</h2><p>I pretty much have to just</p><ul><li>implement the <a href=https://developer.android.com/reference/android/app/NotificationListenerService rel="nofollow noreferrer" target=_blank>NotificationListenerService</a> service, and parse the posted notifications,</li></ul><p>extend the <a href=https://developer.android.com/reference/android/app/NotificationListenerService rel="nofollow noreferrer" target=_blank>NotificationListenerService</a> class and implement the <a href=https://developer.android.com/reference/android/app/NotificationListenerService.OnNotificationPostedListener.html#onNotificationPosted rel="nofollow noreferrer" target=_blank>onNotificationPosted</a> method &amp; <a href=https://developer.android.com/reference/android/app/NotificationListenerService.OnNotificationConnectedListener.html#onNotificationConnected rel="nofollow noreferrer" target=_blank>onNotificationConnected</a> method.</p><pre><code class=language-kt>class NotificationListener : NotificationListenerService() {
    override fun onListenerConnected() {
        super.onListenerConnected()
        appNotificationHelper?.updateNotification(&quot;AdSilence, listening for ads&quot;)?.run {
            startForeground(NOTIFICATION_ID, this) // persistent notification
        }
        Log.v(TAG, &quot;notification listener connected&quot;)
    }

    override fun onNotificationPosted(sbn: StatusBarNotification?) {
        super.onNotificationPosted(sbn)
    }
}
</code></pre><ul><li><p>why do I need to run it as a foreground service?</p><ul><li>because In recent versions of android, any app that is actively running the background must post a notification to the status bar. Otherwise the app will be killed by the system.</li></ul></li><li><p>then mute/unmute the app based on the content,</p><pre><code class=language-kt>
sbn?.let {
with(AppNotification(applicationContext, it.notification, sbn.packageName)) {
    Preference(applicationContext).isAppConfigured(this.getApp()).takeIf { b -&gt; b }
        ?.run {
            Utils().run {
                when (NotificationParser(this@with).isAd()) {
                    true -&gt; {
                        this.mute()
                        isMuted = true
                    }
                    false -&gt; {
                        isMuted = false
                        this.unmute();
                    )
                }
            }
        }
    }
}
}
</code></pre></li><li><p>next important step is granting the app, the permission to listen to notifications. (if all apps can listen to incoming notifications, this would be a huge security flaw!)</p><ul><li><a href=https://developer.android.com/training/permissions/requesting rel="nofollow noreferrer" target=_blank>grant permission</a></li><li>since this app is openSource, everyone can see the source code before granting permission</li><li><p>bascially the following one line has to be used. (note: using string to support older devices)</p><pre><code class=language-kotlin>startActivity(Intent(&quot;enabled_notification_listeners&quot;))
</code></pre></li></ul></li><li><p>in the android manifest, add the following to the <code>&lt;application&gt;</code> tag,</p><ul><li><p>telling the system to use the file <code>NotificationListenerService</code> as the notification listener service.</p><pre><code class=language-xml>&lt;service android:name=&quot;.NotificationListener&quot;
    android:label=&quot;@string/notification_listener_name&quot;
    android:permission=&quot;android.permission.BIND_NOTIFICATION_LISTENER_SERVICE&quot;
    android:exported=&quot;false&quot;&gt;
    &lt;intent-filter&gt;
        &lt;action android:name=&quot;android.service.notification.NotificationListenerService&quot; /&gt;
    &lt;/intent-filter&gt;
&lt;/service&gt;
</code></pre></li></ul></li></ul><h2 id=conclusion>Conclusion</h2><p>That is all is required to get the app to work, there are other things like UI, checking app installed or not, maintaining the app running in the background, hiding the app from recents, restarting the service, preference&hellip;etc. Since the app is so lightweight (around 150KB)&hellip;</p><p>I could write about every part of the app in this, but this app is open source&hellip;.its already explained. It was so refreshing and fun work on this&hellip; Kotlin is fun and I am glad to have learned it(atleast some bit).</p><ul><li><a href=https://github.com/aghontpi/ad-silence rel="nofollow noreferrer" target=_blank>Github/source code</a></li><li><a href="https://play.google.com/store/apps/details?id=bluepie.ad_silence" rel="nofollow noreferrer" target=_blank>Google play store link</a></li><li><a href=https://f-droid.org/packages/bluepie.ad_silence/ rel="nofollow noreferrer" target=_blank>Fdroid link</a></li></ul><hr><ul><li><a href=https://youtu.be/hWfiQN4IUFM rel="nofollow noreferrer" target=_blank>featured in top apps - youtube</a></li><li><a href=https://www.nextpit.com/apps-of-the-week-48-2021 rel="nofollow noreferrer" target=_blank>featured in app of the week</a></li></ul></div><div class=post-copyright><p class=copyright-item><span>Author:</span>
<span>Bluepie</span></p><p class=copyright-item><span>Link:</span>
<a href=//bluepie.in/2021/11/accuradio-spotify-adblocker-in-kotlin/>//bluepie.in/2021/11/accuradio-spotify-adblocker-in-kotlin/</span></p></div><div class=post-tags><section><a href=javascript:window.history.back();>back</a></span> Â·
<span><a href=//bluepie.in/>home</a></span></section></div><div class=post-nav><a href=//bluepie.in/2021/10/open-source-dnd-email-editor/ class=prev rel=prev title="Open Source Dnd Email Editor"><i class="iconfont icon-left"></i>&nbsp;Open Source Dnd Email Editor</a></div><div class=post-comment><div id=disqus_thread></div><script type=application/javascript>var disqus_config=function(){};(function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById('disqus_thread').innerHTML='Disqus comments not available by default when the website is previewed locally.';return;}
var d=document,s=d.createElement('script');s.async=true;s.src='//'+"gopinath001-github-io-blog"+'.disqus.com/embed.js';s.setAttribute('data-timestamp',+new Date());(d.head||d.body).appendChild(s);})();</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></article></div></main><footer class=footer><div class=copyright>&copy;
<span itemprop=copyrightYear>2017 - 2022</span>
<span class=with-love>|</span>
<span class=author itemprop=copyrightHolder><a href=//bluepie.in/>Bluepie</a></span></div></footer><link href=//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css rel=stylesheet><script src=//bluepie.in/js/vendor_gallery.min.js async></script></div></body></html>